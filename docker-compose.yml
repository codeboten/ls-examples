version: "3.7"
services:
    ###########################
    ####### Go examples #######
    ###########################
    go-server:
        container_name: go-server
        build: ./go/opentracing/server
        networks:
            - demo
        env_file:
            - .env
        environment:
            - LIGHTSTEP_COMPONENT_NAME=demo-server-go
            - LIGHTSTEP_SERVICE_VERSION=5
        stop_grace_period: 1s
    go-client:
        container_name: go-client
        build: ./go/opentracing/client
        networks:
            - demo
        depends_on:
            - go-server
        env_file:
            - .env
        environment:
            - LIGHTSTEP_COMPONENT_NAME=demo-client-go
            - LIGHTSTEP_SERVICE_VERSION=1.2.7
            - TARGET_URL=http://go-server:8081
        stop_grace_period: 1s
    go-server-otel:
        container_name: go-server-otel
        build: ./go/opentelemetry/server
        networks:
            - demo
        env_file:
            - .env
        environment:
            - LIGHTSTEP_COMPONENT_NAME=demo-server-go-otel
            - LIGHTSTEP_SERVICE_VERSION=5
        stop_grace_period: 1s
    go-client-otel:
        container_name: go-client-otel
        build: ./go/opentelemetry/client
        networks:
            - demo
        depends_on:
            - go-server-otel
        env_file:
            - .env
        environment:
            - LIGHTSTEP_COMPONENT_NAME=demo-client-go-otel
            - LIGHTSTEP_SERVICE_VERSION=1.2.7
            - TARGET_URL=http://go-server-otel:8081
        stop_grace_period: 1s
    go-otlp-server:
        container_name: go-otlp-server
        build: ./go/otlp/server
        networks:
            - demo
        env_file:
            - .env
        depends_on:
            - otel-collector
        environment:
            - LS_SATELLITE_URL=ingest.lightstep.com:443
            - LS_SERVICE_NAME=demo-go-otlp-server
            - LS_SERVICE_VERSION=9.9.1
        stop_grace_period: 1s
    go-otlp-client:
        container_name: go-otlp-client
        build: ./go/otlp/client
        networks:
            - demo
        depends_on:
            - go-otlp-server
            - otel-collector
        env_file:
            - .env
        environment:
            - LS_SATELLITE_URL=ingest.lightstep.com:443
            - LS_SERVICE_NAME=demo-go-otlp-client
            - LS_SERVICE_VERSION=9.9.2
            - TARGET_URL=http://go-otlp-server:8081
        stop_grace_period: 1s
    go-launcher-server:
        container_name: go-launcher-server
        build: ./go/launcher/server
        networks:
            - demo
        env_file:
            - .env
        environment:
            - LS_SERVICE_NAME=demo-go-launcher-server
            - LS_SERVICE_VERSION=9.9.9
        stop_grace_period: 1s
    go-launcher-client:
        container_name: go-launcher-client
        build: ./go/launcher/client
        networks:
            - demo
        depends_on:
            - go-launcher-server
        env_file:
            - .env
        environment:
            - LS_SERVICE_NAME=demo-go-launcher-client
            - LS_SERVICE_VERSION=9.9.8
            - DESTINATION_URL=http://go-launcher-server:8081
        stop_grace_period: 1s
    ###############################
    ####### Python examples #######
    ###############################
    py-lstrace-client:
        container_name: py-lstrace-client
        build:
            context: ./python
            dockerfile: Dockerfile.client.lstrace
        networks:
            - demo
        depends_on:
            - py-lstrace-server
        env_file:
            - .env
        environment:
            - LIGHTSTEP_COMPONENT_NAME=demo-py-lstrace-client
            - LIGHTSTEP_SERVICE_VERSION=1.2.1
            - TARGET_URL=http://py-lstrace-server:5000
        stop_grace_period: 1s
    py-lstrace-server:
        container_name: py-lstrace-server
        build:
            context: ./python
            dockerfile: Dockerfile.server.lstrace
        networks:
            - demo
        env_file:
            - .env
        environment:
            - LIGHTSTEP_COMPONENT_NAME=demo-py-lstrace-server
            - LIGHTSTEP_SERVICE_VERSION=0.2.2
        stop_grace_period: 1s
    py-otel-client:
        container_name: py-otel-client
        build:
            context: ./python
            dockerfile: Dockerfile.client.otel
        networks:
            - demo
        depends_on:
            - py-otel-server
        env_file:
            - .env
        environment:
            - OPENTELEMETRY_INSTRUMENTATION=1
            - OPENTELEMETRY_PYTHON_tracer_provider=sdk_tracer_provider
            - LIGHTSTEP_SERVICE_NAME=demo-py-otel-client
            - LIGHTSTEP_SERVICE_VERSION=1.2.6
            - TARGET_URL=http://py-otel-server:5000
        stop_grace_period: 1s
    py-otel-server:
        container_name: py-otel-server
        build:
            context: ./python
            dockerfile: Dockerfile.server.otel
        networks:
            - demo
        env_file:
            - .env
        environment:
            - OPENTELEMETRY_INSTRUMENTATION=1
            - OPENTELEMETRY_PYTHON_tracer_provider=sdk_tracer_provider
            - LIGHTSTEP_SERVICE_NAME=demo-py-otel-server
            - LIGHTSTEP_SERVICE_VERSION=0.2.7
        stop_grace_period: 1s
    py-collector-client:
        container_name: py-collector-client
        build:
            context: ./python
            dockerfile: Dockerfile.client.otel
        networks:
            - demo
        depends_on:
            - py-collector-server
            - otel-collector
        env_file:
            - .env
        environment:
            - OPENTELEMETRY_INSTRUMENTATION=1
            - OPENTELEMETRY_EXPORTER=collector
            - INSECURE=1
            - COLLECTOR_ENDPOINT=otel-collector:55678
            - OPENTELEMETRY_PYTHON_tracer_provider=sdk_tracer_provider
            - LIGHTSTEP_SERVICE_NAME=demo-py-collector-client
            - LIGHTSTEP_SERVICE_VERSION=1.2.9
            - TARGET_URL=http://py-collector-server:5000
        stop_grace_period: 1s
    py-collector-server:
        container_name: py-collector-server
        build:
            context: ./python
            dockerfile: Dockerfile.server.otel
        networks:
            - demo
        depends_on:
            - otel-collector
        env_file:
            - .env
        environment:
            - OPENTELEMETRY_INSTRUMENTATION=1
            - OPENTELEMETRY_EXPORTER=collector
            - INSECURE=1
            - COLLECTOR_ENDPOINT=otel-collector:55678
            - OPENTELEMETRY_PYTHON_tracer_provider=sdk_tracer_provider
            - LIGHTSTEP_SERVICE_NAME=demo-py-collector-server
            - LIGHTSTEP_SERVICE_VERSION=0.2.8
        stop_grace_period: 1s
    py-otlp-client:
        container_name: py-otlp-client
        build:
            context: ./python
            dockerfile: Dockerfile.client.otel
        networks:
            - demo
        depends_on:
            - py-otlp-server
        env_file:
            - .env
        environment:
            - OPENTELEMETRY_INSTRUMENTATION=1
            - OPENTELEMETRY_EXPORTER=collector
            - COLLECTOR_ENDPOINT=ingest.lightstep.com:443
            - OPENTELEMETRY_PYTHON_tracer_provider=sdk_tracer_provider
            - LIGHTSTEP_SERVICE_NAME=demo-py-otlp-client
            - LIGHTSTEP_SERVICE_VERSION=10.10.10
            - TARGET_URL=http://py-otlp-server:5000
        stop_grace_period: 1s
    py-otlp-server:
        container_name: py-otlp-server
        build:
            context: ./python
            dockerfile: Dockerfile.server.otel
        networks:
            - demo
        env_file:
            - .env
        environment:
            - OPENTELEMETRY_INSTRUMENTATION=1
            - OPENTELEMETRY_EXPORTER=collector
            - COLLECTOR_ENDPOINT=ingest.lightstep.com:443
            - OPENTELEMETRY_PYTHON_tracer_provider=sdk_tracer_provider
            - LIGHTSTEP_SERVICE_NAME=demo-py-otlp-server
            - LIGHTSTEP_SERVICE_VERSION=10.10.9
        stop_grace_period: 1s
    py-launcher-client:
        container_name: py-launcher-client
        build:
            context: ./python
            dockerfile: Dockerfile.client.launcher
        networks:
            - demo
        depends_on:
            - py-launcher-server
        env_file:
            - .env
        environment:
            - OPENTELEMETRY_PYTHON_tracer_provider=sdk_tracer_provider
            - LS_SERVICE_NAME=demo-py-launcher-client
            - LS_SERVICE_VERSION=10.10.10
            - DESTINATION_URL=http://py-launcher-server:5000
        stop_grace_period: 1s
    py-launcher-server:
        container_name: py-launcher-server
        build:
            context: ./python
            dockerfile: Dockerfile.server.launcher
        networks:
            - demo
        env_file:
            - .env
        environment:
            - OPENTELEMETRY_PYTHON_tracer_provider=sdk_tracer_provider
            - LS_SERVICE_NAME=demo-py-launcher-server
            - LS_SERVICE_VERSION=10.10.9
        stop_grace_period: 1s
    ###################################
    ####### Javascript examples #######
    ###################################
    js-server:
        container_name: js-server
        build: ./js/server
        networks:
            - demo
        env_file:
            - .env
        environment:
            - LIGHTSTEP_COMPONENT_NAME=ls-trace-js-server
        stop_grace_period: 1s
    js-client:
        container_name: js-client
        build: ./js/client
        networks:
            - demo
        depends_on:
            - js-server
        env_file:
            - .env
        environment:
            - LIGHTSTEP_COMPONENT_NAME=ls-trace-js-client
            - TARGET_URL=http://js-server:8080/ping
        stop_grace_period: 1s
    ##############################
    ####### Java examples ########
    ##############################
    java-server:
        container_name: java-server
        build: ./java/server
        networks:
            - demo
        env_file:
            - .env
        environment:
            - LIGHTSTEP_COMPONENT_NAME=demo-server-java
            - LIGHTSTEP_SERVICE_VERSION=4.3.2
        stop_grace_period: 1s
    java-client:
        container_name: java-client
        build: ./java/client
        networks:
            - demo
        depends_on:
            - java-server
        env_file:
            - .env
        environment:
            - LIGHTSTEP_COMPONENT_NAME=demo-client-java
            - LIGHTSTEP_SERVICE_VERSION=3.2.1
            - TARGET_URL=http://java-server:8083
        stop_grace_period: 1s
    java-otlp-client:
        container_name: java-otlp-client
        build:
            context: ./java/otlp
            dockerfile: Dockerfile.client
        networks:
            - demo
        env_file:
            - .env
        environment:
            - OTEL_RESOURCE_ATTRIBUTES=service.name=demo-java-otlp-client
            - LIGHTSTEP_SERVICE_VERSION=11.11.10
            - LS_SATELLITE_URL=ingest.lightstep.com:443
            - TARGET_URL=http://java-otlp-server:8083
        stop_grace_period: 1s
    java-otlp-server:
        container_name: java-otlp-server
        build:
            context: ./java/otlp
            dockerfile: Dockerfile.server
        networks:
            - demo
        env_file:
            - .env
        environment:
            - OTEL_RESOURCE_ATTRIBUTES=service.name=demo-java-otlp-server
            - LIGHTSTEP_SERVICE_VERSION=11.11.11
            - LS_SATELLITE_URL=ingest.lightstep.com:443
        stop_grace_period: 1s
    ##############################
    ####### Extra services #######
    ##############################
    mongo:
        container_name: mongo
        image: mongo:latest
        networks:
            - demo
        stop_grace_period: 1s
        ports:
            - 0.0.0.0:27017:27017
    mysql:
        container_name: mysql
        image: mysql:5.7
        restart: always
        environment:
            MYSQL_USER: testuser
            MYSQL_PASSWORD: testpassword
            MYSQL_ALLOW_EMPTY_PASSWORD: "yes"
            MYSQL_DATABASE: opentelemetry-tests
        networks:
            - demo
        stop_grace_period: 1s
    postgres:
        container_name: postgres
        image: postgres:10.5-alpine
        environment:
            POSTGRES_USER: testuser
            POSTGRES_PASSWORD: testpassword
            POSTGRES_DB: opentelemetry-tests
        networks:
            - demo
        ports:
            - 0.0.0.0:5432:5432
        stop_grace_period: 1s
    redis:
        container_name: redis
        image: redis:4.0-alpine
        networks:
            - demo
        ports:
            - 0.0.0.0:6379:6379
        stop_grace_period: 1s
    otel-collector:
        container_name: otel-collector
        image: otel/opentelemetry-collector-contrib:latest
        command: ["--config=/conf/collector-config.yaml", "--log-level=DEBUG"]
        networks:
            - demo
        # depends_on:
        #     - satellite
        volumes:
            - ./collector/collector-config.yaml:/conf/collector-config.yaml
        ports:
            - "0.0.0.0:8889:8889"   # Prometheus exporter metrics
            - "0.0.0.0:55678:55678" # OpenCensus receiver
            - "0.0.0.0:55680:55680" # OTLP receiver
    # optionally configure a satellite here
    # satellite:
    #     container_name: satellite
    #     image: satlocal:latest
    #     env_file:
    #         - .env
    #     networks:
    #         - demo
    #     ports:
    #         - "0.0.0.0:8360:8360"   # Satellite ingest port
    #     stop_grace_period: 1s
networks:
    demo:
